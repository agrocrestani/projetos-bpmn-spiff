<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:spiffworkflow="http://spiffworkflow.org/bpmn/schema/1.0/core" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="Definitions_96f6665" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="3.0.0-dev">
  <bpmn:process id="Process_ajuste_custo_sap_5dnpvbm" isExecutable="true">
    <bpmn:startEvent id="StartEvent_1">
      <bpmn:outgoing>Flow_17db3yp</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:sequenceFlow id="Flow_17db3yp" sourceRef="StartEvent_1" targetRef="SELECIONAR_PRODUTO" />
    <bpmn:endEvent id="EndEvent_1">
      <bpmn:incoming>Flow_053mnsg</bpmn:incoming>
      <bpmn:incoming>Flow_129ouwj</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:scriptTask id="BuscaProdutosPorDepositoSAP" name="Busca Produtos por Deposito no SAP">
      <bpmn:extensionElements>
        <spiffworkflow:instructionsForEndUser />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_13pu6hq</bpmn:incoming>
      <bpmn:incoming>Flow_10e4xqh</bpmn:incoming>
      <bpmn:outgoing>Flow_12354sq</bpmn:outgoing>
      <bpmn:script>from connectordb.hana import Hana

consulta_movimentos = []

connection = {
    "address": "172.20.1.4",
    "port": "30015",
    "user": "SYSTEM",
    "password": "9Ab63^Op33"
}

query_movimento = f"""
                SELECT 
                    t0."ORIGEM" ,
                    CAST(t0."ItemCode" AS VARCHAR(100)) AS "Produto" ,
                    t0."TIPO" ,
                    CAST(t0."DocDueDate" AS VARCHAR(100)) AS "DocDueDate" ,
                    CAST(t0."TaxDate" AS VARCHAR(100)) AS "TaxDate" ,
                    CAST(t0."DocNum" AS VARCHAR(100)) AS "DocNum",
                    CAST(t0."QTDE" AS VARCHAR(100)) AS "QTDE",
                    CAST(t0."LineTotal" AS VARCHAR(100)) AS "LineTotal",
                    CAST(t0."unitMsr" AS VARCHAR(100)) AS "unitMsr" ,
                    CAST(t0."BaseType" AS VARCHAR(100)) AS "BaseType" ,
                    CAST(t0."BaseRef" AS VARCHAR(100)) AS "BaseRef" ,
                    CAST(t0."CreateDate" AS VARCHAR(100)) AS "CreateDate" ,
                    CAST(t0."CreateTS" AS VARCHAR(100)) AS "CreateTS" ,
                    CAST(t0.CANCELED AS VARCHAR(2)) AS "CANCELED" ,
                    CAST(t0."StockPrice" AS VARCHAR(100)) AS "StockPrice",
                    CAST(t0."ObjType" AS VARCHAR(3)) AS "ObjType",
                    CAST(t0."AcctCode" AS VARCHAR(100)) AS "AcctCode"
                FROM {baseSap}.AC_MOVIMENTOS t0
                WHERE 
                    t0."ItemCode" = '{produto['ItemCode']}' AND
	                t0."WhsCode" = '{deposito}' AND
                    (t0."DocDueDate" &gt;= '{dataInicio}' OR {dataInicio} IS NULL) AND 
                    (t0."DocDueDate" &lt;= '{dataFinal}' OR {dataFinal} IS NULL)
                ORDER BY t0."CreateDate", t0."CreateTS"
                """   
                    
consulta_movimentos = Hana(connection).selectDb(query_movimento)

if(consulta_movimentos != []):
    query_um_produto_estoque =  f"""
                    SELECT  
                        t0."InvntryUom",
                        t0."ItemName"
                    FROM {baseSap}.OITM t0
                    WHERE t0."ItemCode" = '{produto['ItemCode']}';
                    """

    um_produto_estoque = Hana(connection).selectDb(query_um_produto_estoque)
    
    desc_produto = um_produto_estoque[0]['itemname']    
    query_deposito = f"""
                    SELECT  
                        CAST(t0."AvgPrice" AS VARCHAR(50)) AS "AvgPrice",
                        CAST(t0."OnHand" AS VARCHAR(50)) AS "OnHand"
                    FROM {baseSap}.OITW t0
                    WHERE t0."ItemCode" = '{produto['ItemCode']}' AND t0."WhsCode" = '{deposito}';
                    """
    
    deposito_estoque = Hana(connection).selectDb(query_deposito)
    custo_produto_deposito = float(deposito_estoque[0]['avgprice'].replace(",", "."))
    on_hand_deposito = float(deposito_estoque[0]['onhand'].replace(",", "."))
    del(deposito_estoque)
    del(query_deposito)
    
    num_movimentos = 0

    # Lista para armazenar os elementos a serem removidos
    indices_para_remover = []

    # Iterar sobre os elementos da lista
    for i, movimento in enumerate(consulta_movimentos):
        # Verificar se a origem é "	7-Nfe.Entrada" e basetype é 20 e baseref é igual ao docnum do elemento de "11-Recebimento de Mercadoria"
        if movimento["origem"] == "7-Nfe.Entrada" and movimento["basetype"] == "20":
            for movimento_recebimento in consulta_movimentos:
                if movimento_recebimento["origem"] == "11-Recebimento de Mercadoria" and movimento_recebimento["docnum"] == movimento["baseref"]:
                    indices_para_remover.append(i)
        if movimento['origem'] == '1-Saldo Inicial':
            movimento['unitmsr'] = um_produto_estoque[0]['invntryuom']
            movimento['canceled'] = 'N'
        
        ano = movimento['docduedate'][0:4]
        mes = movimento['docduedate'][5:7]
        dia = movimento['docduedate'][8:10]

        movimento['docduedate'] = "{}/{}/{}".format(dia, mes, ano)

        ano = movimento['taxdate'][0:4]
        mes = movimento['taxdate'][5:7]
        dia = movimento['taxdate'][8:10]

        movimento['taxdate'] = "{}/{}/{}".format(dia, mes, ano)

        ano = movimento['createdate'][0:4]
        mes = movimento['createdate'][5:7]
        dia = movimento['createdate'][8:10]

        movimento['createdate'] = "{}/{}/{}".format(dia, mes, ano)

    if(indices_para_remover != []):
        # Remover os elementos da lista
        for indice in sorted(indices_para_remover, reverse=True):
            del consulta_movimentos[indice]
    
        del(indice)
        del(movimento_recebimento)

    del(indices_para_remover)
    del(movimento)
    del(query_um_produto_estoque)

del(connection)
del(query_movimento)
del(baseSap)

# Dicionário para agrupar os docnum por objtype
agrupados_por_objtype = {}

# Percorrendo a lista de documentos
for documento in consulta_movimentos:
    objtype = documento["objtype"]
    docnum = documento["docnum"]
    
    # Se o objtype ainda não está no dicionário, adicionar uma nova lista
    if objtype not in agrupados_por_objtype:
        agrupados_por_objtype[objtype] = []
    
    # Adicionar o docnum à lista correspondente ao objtype
    agrupados_por_objtype[objtype].append(docnum)

visao = 'estoque'</bpmn:script>
    </bpmn:scriptTask>
    <bpmn:subProcess id="Activity_1d1r8sl">
      <bpmn:extensionElements>
        <spiffworkflow:postScript>del(x)</spiffworkflow:postScript>
        <spiffworkflow:preScript />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_1yez69d</bpmn:incoming>
      <bpmn:outgoing>Flow_0kxg7eo</bpmn:outgoing>
      <bpmn:multiInstanceLoopCharacteristics isSequential="true" spiffworkflow:scriptsOnInstances="true">
        <bpmn:loopDataInputRef>consulta_movimentos</bpmn:loopDataInputRef>
        <bpmn:loopDataOutputRef>consulta_movimentos_out</bpmn:loopDataOutputRef>
        <bpmn:inputDataItem id="x" name="x" />
      </bpmn:multiInstanceLoopCharacteristics>
      <bpmn:startEvent id="Event_117o128">
        <bpmn:outgoing>Flow_1l99k7c</bpmn:outgoing>
      </bpmn:startEvent>
      <bpmn:businessRuleTask id="ConversorUnidadeMedida" name="Conversor de Unidade de Medida">
        <bpmn:extensionElements>
          <spiffworkflow:preScript>unidadeDocumento = x['unitmsr']
unidadeEstoque = um_produto_estoque[0]['invntryuom']</spiffworkflow:preScript>
          <spiffworkflow:postScript>multiplicador = multiplicador

</spiffworkflow:postScript>
          <spiffworkflow:calledDecisionId>decision_1</spiffworkflow:calledDecisionId>
        </bpmn:extensionElements>
        <bpmn:incoming>Flow_1l99k7c</bpmn:incoming>
        <bpmn:outgoing>Flow_0f953hs</bpmn:outgoing>
      </bpmn:businessRuleTask>
      <bpmn:sequenceFlow id="Flow_1l99k7c" sourceRef="Event_117o128" targetRef="ConversorUnidadeMedida" />
      <bpmn:sequenceFlow id="Flow_0f953hs" sourceRef="ConversorUnidadeMedida" targetRef="NormalizandoEstoque" />
      <bpmn:scriptTask id="NormalizandoEstoque" name="Normalizando Estoque">
        <bpmn:incoming>Flow_0f953hs</bpmn:incoming>
        <bpmn:outgoing>Flow_14z5yhx</bpmn:outgoing>
        <bpmn:script>
num_movimentos += 1
if(x['origem'] == '12-Ajuste de Estoque'):
    precoProdutoNormalizado = float(x["stockprice"].replace(",", "."))
else:
    precoProdutoNormalizado = float(x["linetotal"].replace(",", ".")) / float(x["qtde"].replace(",", ".")) / multiplicador
    
quantidadeEstoqueNormalizada = multiplicador * float(x["qtde"].replace(",", "."))
precoTotalNormalizado = float(x["linetotal"].replace(",", "."))

x['stockprice'] = float(x["stockprice"].replace(",", "."))

if(x['origem'] == '7-Nfe.Entrada' and (x['canceled'] == 'C')):
    quantidadeEstoqueNormalizada = quantidadeEstoqueNormalizada * -1
    precoProdutoNormalizado = precoProdutoNormalizado * -1
    precoTotalNormalizado = precoTotalNormalizado * -1

x['qtde'] = quantidadeEstoqueNormalizada
x['preco_unitario'] = precoProdutoNormalizado
x['linetotal'] = precoTotalNormalizado
x['num_movimentos'] = num_movimentos

consulta_movimentos_out.append(x)

del(quantidadeEstoqueNormalizada)
del(precoProdutoNormalizado)
del(precoTotalNormalizado)
</bpmn:script>
      </bpmn:scriptTask>
      <bpmn:endEvent id="Event_1dydh6d">
        <bpmn:incoming>Flow_14z5yhx</bpmn:incoming>
      </bpmn:endEvent>
      <bpmn:sequenceFlow id="Flow_14z5yhx" sourceRef="NormalizandoEstoque" targetRef="Event_1dydh6d" />
    </bpmn:subProcess>
    <bpmn:sequenceFlow id="Flow_12354sq" sourceRef="BuscaProdutosPorDepositoSAP" targetRef="Gateway_0mqija0" />
    <bpmn:sequenceFlow id="Flow_0kxg7eo" sourceRef="Activity_1d1r8sl" targetRef="ESCOLHA_VISAO" />
    <bpmn:sequenceFlow id="Flow_13pu6hq" sourceRef="Activity_00bh8bd" targetRef="BuscaProdutosPorDepositoSAP" />
    <bpmn:userTask id="Activity_00bh8bd" name="Selecionar Produto e Deposito">
      <bpmn:extensionElements>
        <spiffworkflow:properties>
          <spiffworkflow:property name="formJsonSchemaFilename" value="selecionar-produto-deposito-schema.json" />
          <spiffworkflow:property name="formUiSchemaFilename" value="selecionar-produto-deposito-uischema.json" />
        </spiffworkflow:properties>
        <spiffworkflow:preScript>from connectordb.hana import Hana


connection = {
    "address": "172.20.1.4",
    "port": "30015",
    "user": "SYSTEM",
    "password": "9Ab63^Op33"
}

query_depositos = f"""
                    SELECT DISTINCT 
                        CAST(t0."WhsCode" AS VARCHAR(50)) AS "whscode",
                        COALESCE(CAST(t1."WhsName" AS VARCHAR(50)), '') AS "whsname"
                    FROM 
                        {baseSap}.OITW t0
                        LEFT JOIN {baseSap}.OWHS t1 ON t1."WhsCode" = t0."WhsCode"
                    WHERE (t0."AvgPrice" &gt; 0 OR t0."OnHand" &gt; 0) AND t0."ItemCode" LIKE '{produto['ItemCode']}'
                """


consulta_depositos = Hana(connection).selectDb(query_depositos)

del(query_depositos)
del(connection)

depositosList = []
for deposito in consulta_depositos:
    depositosList.append(
        {
            "value" : deposito['whscode'] ,
            "label" : deposito['whscode'] + ' - ' + deposito['whsname']
        }
    )

del(deposito)
del(consulta_depositos)
</spiffworkflow:preScript>
        <spiffworkflow:instructionsForEndUser />
        <spiffworkflow:postScript>del(depositosList)</spiffworkflow:postScript>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_0ho3zz6</bpmn:incoming>
      <bpmn:incoming>Flow_0syy6uu</bpmn:incoming>
      <bpmn:outgoing>Flow_13pu6hq</bpmn:outgoing>
    </bpmn:userTask>
    <bpmn:exclusiveGateway id="Gateway_0mqija0" default="Flow_1yez69d">
      <bpmn:incoming>Flow_12354sq</bpmn:incoming>
      <bpmn:outgoing>Flow_1yez69d</bpmn:outgoing>
      <bpmn:outgoing>Flow_1462x9u</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:sequenceFlow id="Flow_1yez69d" sourceRef="Gateway_0mqija0" targetRef="Activity_1d1r8sl">
      <bpmn:conditionExpression>consulta_movimentos != []</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_1462x9u" sourceRef="Gateway_0mqija0" targetRef="MovimentoEntradaNaoEncontrado">
      <bpmn:conditionExpression>consulta_movimentos == []</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:exclusiveGateway id="Gateway_0zhxafw" default="Flow_0ho3zz6">
      <bpmn:incoming>Flow_0n3n3cb</bpmn:incoming>
      <bpmn:outgoing>Flow_0ho3zz6</bpmn:outgoing>
      <bpmn:outgoing>Flow_129ouwj</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:sequenceFlow id="Flow_0n3n3cb" sourceRef="MovimentoEntradaNaoEncontrado" targetRef="Gateway_0zhxafw" />
    <bpmn:sequenceFlow id="Flow_0ho3zz6" sourceRef="Gateway_0zhxafw" targetRef="Activity_00bh8bd">
      <bpmn:conditionExpression>novaBusca == True</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:userTask id="MovimentoEntradaNaoEncontrado" name="Movimento de Entrada não encontrado">
      <bpmn:extensionElements>
        <spiffworkflow:instructionsForEndUser>## &lt;span style="font-weight: bold; color: red;"&gt;Nenhum movimento de entrada encontrado para o &lt;br&gt;Produto &lt;span style="color: black;"&gt; **{{produto}}**&lt;/span&gt; e depósito &lt;span style="color: black;"&gt;**{{deposito}}**&lt;/span&gt; !!&lt;/span&gt;

</spiffworkflow:instructionsForEndUser>
        <spiffworkflow:properties>
          <spiffworkflow:property name="formJsonSchemaFilename" value="selecionar-novos-parametros-schema.json" />
          <spiffworkflow:property name="formUiSchemaFilename" value="selecionar-novos-parametros-uischema.json" />
        </spiffworkflow:properties>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_1462x9u</bpmn:incoming>
      <bpmn:outgoing>Flow_0n3n3cb</bpmn:outgoing>
    </bpmn:userTask>
    <bpmn:exclusiveGateway id="REPROCESSAR01" name="Reprocessar" default="Flow_053mnsg">
      <bpmn:incoming>Flow_0m9nzqu</bpmn:incoming>
      <bpmn:incoming>Flow_04afnxr</bpmn:incoming>
      <bpmn:outgoing>Flow_10e4xqh</bpmn:outgoing>
      <bpmn:outgoing>Flow_053mnsg</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:userTask id="VISAO_SAP" name="Visão do SAP">
      <bpmn:extensionElements>
        <spiffworkflow:properties>
          <spiffworkflow:property name="formJsonSchemaFilename" value="calculo-custo-estoque-schema.json" />
          <spiffworkflow:property name="formUiSchemaFilename" value="calculo-custo-estoque-uischema.json" />
        </spiffworkflow:properties>
        <spiffworkflow:preScript># Inicialize as variáveis para calcular o custo médio unitário
total_preco_unitario_entrada = 0
total_quantidade_entrada = 0
custo_medio_total_calculado_entrada = 0
custo_medio_unitario_calculado_entrada = 0

total_preco_unitario_saida = 0
total_quantidade_saida = 0
total_custo_calc_saida = 0
custo_medio_total_calculado_saida = 0
custo_medio_unitario_calculado_saida = 0

try:
    if(lista_documentos_ignorar):
        print('Lista Boa')

    if lista_documentos_ignorar is None:
        lista_documentos_ignorar = []

except:
        lista_documentos_ignorar = []

try:
    if(lista_documentos_ignorar_saida):
        print('Lista Boa')
    if lista_documentos_ignorar_saida is None:
        lista_documentos_ignorar_saida = []
except:
    lista_documentos_ignorar_saida = []


origens_unicas = list(set(item["origem"] for item in consulta_movimentos))
origens_unicas_list = []
for origem in origens_unicas:
    origens_unicas_list.append(
        {
            "value" : origem ,
            "label" : origem
        }
    )

del(origens_unicas)
del(origem)

total_preco_unitario = 0
total_quantidade = 0

entrada = []
saida = []

custo_medio = 0
if isinstance(consulta_movimentos_out, list):
    for produtoAux in consulta_movimentos_out:
        if produtoAux['tipo'] == "E" :
            if produtoAux['canceled'] == 'N':
                total_preco_unitario_entrada += produtoAux['linetotal']
                total_quantidade_entrada += produtoAux['qtde']
                
                total_preco_unitario += produtoAux['linetotal']
                total_quantidade += produtoAux['qtde']
                
                if total_quantidade &gt; 0:
                    custo_medio = total_preco_unitario / total_quantidade
                else: 
                    custo_medio = (custo_medio + (produtoAux['linetotal'] / produtoAux['qtde'])) / 2
                
                produtoAux['custo_medio'] = custo_medio
                produtoAux['estoque_atual'] = total_quantidade
                produtoAux['custo_estoque_atual'] = custo_medio * total_quantidade
                produtoAux['custo_medio_calc'] = produtoAux['linetotal']
                produtoAux['custo_total_contabil'] = produtoAux['linetotal']

                #Calcular Custo Médio da Entrada Ignorando documentos Selecionados
                if(lista_documentos_ignorar != []):
                    ignorar = False

                    for doc_ignorar in lista_documentos_ignorar:
                        tipo_ignorar = doc_ignorar["tipo_documento"]
                        num_ignorar = doc_ignorar["num_documento"]
                        if produtoAux["origem"] == tipo_ignorar and produtoAux["docnum"] == num_ignorar:
                            ignorar = True
                            break

                    if(ignorar == False):
                        custo_medio_total_calculado_entrada += produtoAux['custo_medio_calc']

                        if(custo_medio_unitario_calculado_entrada &gt; 0 ):
                            custo_medio_unitario_calculado_entrada = (custo_medio_unitario_calculado_entrada + produtoAux['custo_medio'])/2
                        else:
                            custo_medio_unitario_calculado_entrada = produtoAux['custo_medio']
                    else:
                        produtoAux['qtde'] = doc_ignorar['qtde']
                        produtoAux['custo_medio_calc'] = doc_ignorar['qtde'] * doc_ignorar['custo_unitario']
                        produtoAux['custo_medio'] = doc_ignorar['custo_unitario']
                        
                        custo_medio_total_calculado_entrada += produtoAux['custo_medio_calc']

                        if(custo_medio_unitario_calculado_entrada &gt; 0 ):
                            custo_medio_unitario_calculado_entrada = (custo_medio_unitario_calculado_entrada + produtoAux['custo_medio'])/2
                        else:
                            custo_medio_unitario_calculado_entrada = produtoAux['custo_medio']


                    del(doc_ignorar)
                    del(ignorar)                      
                else:
                    custo_medio_total_calculado_entrada += produtoAux['custo_medio_calc']
                    
                    if(custo_medio_unitario_calculado_entrada &gt; 0 ):
                        custo_medio_unitario_calculado_entrada = (custo_medio_unitario_calculado_entrada + produtoAux['custo_medio'])/2
                    else:
                        custo_medio_unitario_calculado_entrada = produtoAux['custo_medio']
            else:
                produtoAux['custo_medio'] = 000.000
                produtoAux['estoque_atual'] = 000.000
                produtoAux['custo_medio_calc'] = 000.000
                produtoAux['custo_total_contabil'] = 000.000
                produtoAux['custo_estoque_atual'] = 000.000
        
        if produtoAux['tipo'] == "S":
            if produtoAux['canceled'] == 'N':
                total_preco_unitario_saida += produtoAux['stockprice'] * produtoAux['qtde']
                total_quantidade_saida += produtoAux['qtde']
                produtoAux['custo_medio'] = custo_medio
                produtoAux['custo_medio_calc'] = custo_medio * produtoAux['qtde']
                total_quantidade = produtoAux['qtde'] +  total_quantidade
                produtoAux['estoque_atual'] = total_quantidade
                produtoAux['custo_estoque_atual'] = custo_medio * total_quantidade
                total_custo_calc_saida += produtoAux['custo_medio_calc']
                total_preco_unitario = produtoAux['custo_medio_calc'] + total_preco_unitario 
                produtoAux['custo_total_contabil'] = produtoAux['stockprice'] * produtoAux['qtde']
                produtoAux['preco_unitario'] = produtoAux['stockprice']


                #Calcular Custo Médio da Entrada Ignorando documentos Selecionados
                if(lista_documentos_ignorar_saida != []):
                    ignorar = False

                    for doc_ignorar in lista_documentos_ignorar_saida:
                        tipo_ignorar = doc_ignorar["tipo_documento"]
                        num_ignorar = doc_ignorar["num_documento"]
                        if produtoAux["origem"] == tipo_ignorar and produtoAux["docnum"] == num_ignorar:
                            ignorar = True
                            break
                            
                    del(doc_ignorar)

                    if(ignorar == False):
                        custo_medio_total_calculado_saida += produtoAux['custo_medio_calc']

                        if(custo_medio_unitario_calculado_saida &gt; 0 ):
                            custo_medio_unitario_calculado_saida = (custo_medio_unitario_calculado_saida + produtoAux['custo_medio'])/2
                        else:
                            custo_medio_unitario_calculado_saida = produtoAux['custo_medio']    

                    del(ignorar)
                else:
                    custo_medio_total_calculado_saida += produtoAux['custo_medio_calc']
                    
                    if(custo_medio_unitario_calculado_saida &gt; 0 ):
                        custo_medio_unitario_calculado_saida = (custo_medio_unitario_calculado_saida + produtoAux['custo_medio'])/2
                    else:
                        custo_medio_unitario_calculado_saida = produtoAux['custo_medio']
            
            else:
                produtoAux['custo_medio'] = 000.000
                produtoAux['estoque_atual'] = 000.000
                produtoAux['custo_medio_calc'] = 000.000
                produtoAux['custo_total_contabil'] = 000.000
                produtoAux['custo_estoque_atual'] = 000.000

    del(produtoAux)

else:
    print("Erro: 'produtosDespositos' não é uma lista.")


total_estoque = total_quantidade_saida + total_quantidade_entrada

custo_medio_unitario_entrada = 0
if total_quantidade_entrada != 0:
    custo_medio_unitario_entrada = total_preco_unitario_entrada / total_quantidade_entrada
    print("Custo médio unitário:", custo_medio_unitario_entrada)
else:
    print("Não foi possível calcular o custo médio unitário. Total de quantidade é zero.")

custo_medio_unitario_saida = 0
if total_quantidade_saida != 0:
    custo_medio_unitario_saida = total_preco_unitario_saida / total_quantidade_saida
    print("Custo médio unitário:", custo_medio_unitario_saida)
else:
    print("Não foi possível calcular o custo médio unitário. Total de quantidade é zero.")



recalcular = False

del(consulta_movimentos)</spiffworkflow:preScript>
        <spiffworkflow:postScript>lista_documentos_ignorar = documentos_entrada
lista_documentos_ignorar_saida = documentos_saida

# # Dicionário para agrupar os docnum por objtype
# agrupados_por_objtype = {}

# # Percorrendo a lista de documentos
# for documento in consulta_movimentos_out:
#     objtype = documento["objtype"]
#     docnum = documento["docnum"]
    
#     # Se o objtype ainda não está no dicionário, adicionar uma nova lista
#     if objtype not in agrupados_por_objtype:
#         agrupados_por_objtype[objtype] = []
    
#     # Adicionar o docnum à lista correspondente ao objtype
#     agrupados_por_objtype[objtype].append(docnum)

del(documento)
del(consulta_movimentos_out)
del(origens_unicas_list)
del(documentos_entrada)
del(documentos_saida)</spiffworkflow:postScript>
        <spiffworkflow:instructionsForEndUser>
| Produto | Deposito | Em Estoque | Custo Unitário | 
| ----------- | ----------- | ----------------: | -----------------: | 
| **{{produto}}** - {{desc_produto}} | {{deposito}} | {{ '{:,.3f}'.format(on_hand_deposito).replace(',', ' ').replace('.', ',').replace(' ', '.') }} | {{ '{:,.3f}'.format(custo_produto_deposito).replace(',', ' ').replace('.', ',').replace(' ', '.') }} | 


### Entrada

| Quantidade Total | Custo Médio | Custo Total | Custo Médio Calc. |Custo Total Calc. |
| ---------------------: | ----------------: | --------------: | ----------------------: | ---------------------: |
| {{ '{:,.3f}'.format(total_quantidade_entrada).replace(',', ' ').replace('.', ',').replace(' ', '.') }} | {{ '{:,.3f}'.format(custo_medio_unitario_entrada).replace(',', ' ').replace('.', ',').replace(' ', '.')}} | {{'{:,.3f}'.format(total_preco_unitario_entrada).replace(',', ' ').replace('.', ',').replace(' ', '.') }} | {{'{:,.3f}'.format(custo_medio_unitario_calculado_entrada).replace(',', ' ').replace('.', ',').replace(' ', '.') }} | {{'{:,.3f}'.format(custo_medio_total_calculado_entrada).replace(',', ' ').replace('.', ',').replace(' ', '.') }} |


### Saida

| Quantidade Total | Custo Médio | Custo Total | Custo Médio Calc. |Custo Total Calc. |
| ---------------------: | ----------------: | --------------: | ----------------------: | ---------------------: |
| {{ '{:,.3f}'.format(total_quantidade_saida).replace(',', ' ').replace('.', ',').replace(' ', '.') }} | {{ '{:,.3f}'.format(custo_medio_unitario_saida).replace(',', ' ').replace('.', ',').replace(' ', '.')}} | {{'{:,.3f}'.format(total_preco_unitario_saida).replace(',', ' ').replace('.', ',').replace(' ', '.') }} |  {{'{:,.3f}'.format(custo_medio_unitario_calculado_saida).replace(',', ' ').replace('.', ',').replace(' ', '.') }} | {{'{:,.3f}'.format(custo_medio_total_calculado_saida).replace(',', ' ').replace('.', ',').replace(' ', '.') }} |

### Movimentações

| Num. | Origem | Num. Doc. | Quantidade | Custo Unitário  | Custo Total | Custo Médio Calc. | Custo Calc. | Estoque | Custo Atual Estoque | Data | Canc. |
| ------- | ------- | -------------- | ----------: | ---------------: | ---------------: | ----------- | --------- | --------- | -------: | ----- | ---- |
{% for produto in consulta_movimentos_out %}
| {{ produto['num_movimentos'] }} | {{ produto['origem'] }} | {{ produto['docnum'] }} | {{ '{:,.3f}'.format(produto['qtde']).replace(',', ' ').replace('.', ',').replace(' ', '.') }} | {{ '{:,.3f}'.format(produto['preco_unitario']).replace(',', ' ').replace('.', ',').replace(' ', '.') }} | {{ '{:,.3f}'.format(produto['custo_total_contabil']).replace(',', ' ').replace('.', ',').replace(' ', '.') }} | {{ '{:,.3f}'.format(produto['custo_medio']).replace(',', ' ').replace('.', ',').replace(' ', '.') }} | {{ '{:,.3f}'.format(produto['custo_medio_calc']).replace(',', ' ').replace('.', ',').replace(' ', '.')}} | {{ '{:,.3f}'.format(produto['estoque_atual']).replace(',', ' ').replace('.', ',').replace(' ', '.') }} | {{ '{:,.3f}'.format(produto['custo_estoque_atual']).replace(',', ' ').replace('.', ',').replace(' ', '.') }} | {{produto['docduedate']}} | {{produto['canceled']}} |
{% endfor %}

</spiffworkflow:instructionsForEndUser>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_0gxeqjd</bpmn:incoming>
      <bpmn:outgoing>Flow_0m9nzqu</bpmn:outgoing>
    </bpmn:userTask>
    <bpmn:sequenceFlow id="Flow_10e4xqh" sourceRef="REPROCESSAR01" targetRef="BuscaProdutosPorDepositoSAP">
      <bpmn:conditionExpression>recalcular == True</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_0m9nzqu" sourceRef="VISAO_SAP" targetRef="REPROCESSAR01" />
    <bpmn:exclusiveGateway id="ESCOLHA_VISAO" name="Escolha Visão" default="Flow_1wz3wum">
      <bpmn:incoming>Flow_0kxg7eo</bpmn:incoming>
      <bpmn:outgoing>Flow_0gxeqjd</bpmn:outgoing>
      <bpmn:outgoing>Flow_1wz3wum</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:sequenceFlow id="Flow_0gxeqjd" sourceRef="ESCOLHA_VISAO" targetRef="VISAO_SAP">
      <bpmn:conditionExpression>visao == 'sap'</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_1wz3wum" sourceRef="ESCOLHA_VISAO" targetRef="VISAO_CALCULADA">
      <bpmn:conditionExpression>visao == 'estoque'</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_04afnxr" sourceRef="VISAO_CALCULADA" targetRef="REPROCESSAR01" />
    <bpmn:sequenceFlow id="Flow_053mnsg" sourceRef="REPROCESSAR01" targetRef="EndEvent_1">
      <bpmn:conditionExpression>recalcular == False</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_129ouwj" sourceRef="Gateway_0zhxafw" targetRef="EndEvent_1">
      <bpmn:conditionExpression>novaBusca == False</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_0syy6uu" sourceRef="SELECIONAR_PRODUTO" targetRef="Activity_00bh8bd" />
    <bpmn:userTask id="SELECIONAR_PRODUTO" name="Selecionar Produto">
      <bpmn:extensionElements>
        <spiffworkflow:preScript />
        <spiffworkflow:properties>
          <spiffworkflow:property name="formJsonSchemaFilename" value="selecionar-produto-schema.json" />
          <spiffworkflow:property name="formUiSchemaFilename" value="selecionar-produto-uischema.json" />
        </spiffworkflow:properties>
        <spiffworkflow:postScript>produto = json.loads(produto)
baseSap = get_secret('baseSap')
</spiffworkflow:postScript>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_17db3yp</bpmn:incoming>
      <bpmn:outgoing>Flow_0syy6uu</bpmn:outgoing>
    </bpmn:userTask>
    <bpmn:manualTask id="VISAO_CALCULADA" name="Visão Calculada">
      <bpmn:extensionElements>
        <spiffworkflow:instructionsForEndUser>| Produto | Deposito | Em Estoque | Custo Unitário | 
| ----------- | ----------- | ----------------: | -----------------: | 
| **{{produto['ItemCode']}}** - {{produto['ItemName']}} | {{deposito}} | {{ '{:,.3f}'.format(on_hand_deposito).replace(',', ' ').replace('.', ',').replace(' ', '.') }} | {{ '{:,.3f}'.format(custo_produto_deposito).replace(',', ' ').replace('.', ',').replace(' ', '.') }} | 


### Ficha de Estoque

&lt;table class="stock-table"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th colspan="4" class="header-cell"&gt;Documento &lt;/th&gt;
            &lt;th colspan="3" class="header-cell"&gt;Entrada&lt;/th&gt;
            &lt;th colspan="3" class="header-cell"&gt;Saída&lt;/th&gt;
            &lt;th colspan="3" class="header-cell"&gt;Saldo Acumulado&lt;/th&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;th class="data-cell"&gt;Tipo&lt;/th&gt;
            &lt;th class="data-cell"&gt;Nº&lt;/th&gt;
            &lt;th class="data-cell"&gt;Data Criação&lt;/th&gt;
            &lt;th class="data-cell"&gt;Data Documento&lt;/th&gt;
            &lt;th class="data-cell"&gt;Volume&lt;/th&gt;
            &lt;th class="data-cell"&gt;Valor Unitário&lt;/th&gt;
            &lt;th class="data-cell"&gt;Valor Total&lt;/th&gt;
            &lt;th class="data-cell"&gt;Volume&lt;/th&gt;
            &lt;th class="data-cell"&gt;Valor Unitário&lt;/th&gt;
            &lt;th class="data-cell"&gt;Valor Total&lt;/th&gt;
            &lt;th class="data-cell"&gt;Volume&lt;/th&gt;
            &lt;th class="data-cell"&gt;Custo Médio&lt;/th&gt;
            &lt;th class="data-cell"&gt;Valor Total&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
       {% for produto in consulta_movimentos_out %}
        &lt;tr&gt;
            &lt;td class="data-cell"&gt;{{ produto['origem'] }}&lt;/td&gt;
            &lt;td class="data-cell"&gt;{{ produto['docnum'] }}&lt;/td&gt;
            &lt;td class="data-cell"&gt;{{ produto['createdate'] }}&lt;/td&gt;
            &lt;td class="data-cell"&gt;{{ produto['taxdate'] }}&lt;/td&gt;
            {% if produto['origem'] == '7-Nfe.Entrada' or produto['origem'] == '11-Recebimento de Mercadoria' or produto['origem'] == '2-Ent.Mercadoria' or produto['origem'] == '1-Saldo Inicial' or produto['origem'] == '5-Dev. NFe. Saida' %}
            &lt;td class="data-cell"&gt;{{ '{:,.3f}'.format(produto['qtde']).replace(',', ' ').replace('.', ',').replace(' ', '.') }}&lt;/td&gt;
            &lt;td class="data-cell"&gt;{{ '{:,.3f}'.format(produto['preco_unitario']).replace(',', ' ').replace('.', ',').replace(' ', '.') }}&lt;/td&gt;
            &lt;td class="data-cell"&gt;{{ '{:,.3f}'.format(produto['custo_total_contabil']).replace(',', ' ').replace('.', ',').replace(' ', '.') }}&lt;/td&gt;
            {%else %}
            &lt;td class="data-cell"&gt; &lt;/td&gt;
            &lt;td class="data-cell"&gt; &lt;/td&gt;
            &lt;td class="data-cell"&gt; &lt;/td&gt;
            {% endif %}
            {% if produto['origem'] == '3-Sai.Mercadoria' or produto['origem'] == '4-Nfe.Saida'%}
            &lt;td class="data-cell"&gt;{{ '{:,.3f}'.format(produto['qtde']).replace(',', ' ').replace('.', ',').replace(' ', '.') }}&lt;/td&gt;
            &lt;td class="data-cell"&gt;{{ '{:,.3f}'.format(produto['preco_unitario']).replace(',', ' ').replace('.', ',').replace(' ', '.') }}&lt;/td&gt;
            &lt;td class="data-cell"&gt;{{ '{:,.3f}'.format(produto['custo_total_contabil']).replace(',', ' ').replace('.', ',').replace(' ', '.') }}&lt;/td&gt;
            {%else %}
            &lt;td class="data-cell"&gt; &lt;/td&gt;
            &lt;td class="data-cell"&gt; &lt;/td&gt;
            &lt;td class="data-cell"&gt; &lt;/td&gt;
            {% endif %}
            &lt;td class="data-cell"&gt;{{ '{:,.3f}'.format(produto['estoque_atual']).replace(',', ' ').replace('.', ',').replace(' ', '.') }}&lt;/td&gt;
            &lt;td class="data-cell"&gt;{{ '{:,.3f}'.format(produto['custo_medio']).replace(',', ' ').replace('.', ',').replace(' ', '.') }}&lt;/td&gt;
            &lt;td class="data-cell"&gt;{{ '{:,.3f}'.format(produto['custo_estoque_atual']).replace(',', ' ').replace('.', ',').replace(' ', '.') }}&lt;/td&gt;
        &lt;/tr&gt;
    {% endfor %}
    &lt;/tbody&gt;
&lt;/table&gt;

&lt;style&gt;
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0 !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .stock-table {
            width: 100% !important;
            border-collapse: collapse !important;
            margin-top: 20px !important;
            overflow: hidden !important;
        }

        table {
            display: inline !important;
        }

        .data-cell {
            border: 1px solid #dddddd !important;
            text-align: left !important;
            padding: 12px !important;
            transition: all 0.3s ease !important;
            font-size: 14px !important;
            table-layout: fixed !important;
        }
        .header-cell {
            background-color: #4CAF50 !important;
            color: white !important;
            font-weight: bold !important;
            border-bottom: 2px solid #dddddd !important;
            text-align: center !important;
            padding: 12px !important;
            transition: all 0.3s ease !important;
            font-size: 14px !important;
        }
        .stock-table tbody tr:nth-child(odd) {
            background-color: #ffffff !important; 
        }
        .stock-table tbody tr:nth-child(even) {
            background-color: #f7f7f7 !important;
        }
        .stock-table tbody tr:hover {
            background-color: #ddd !important;
        }
    &lt;/style&gt;
</spiffworkflow:instructionsForEndUser>
        <spiffworkflow:preScript># Inicialize as variáveis para calcular o custo médio unitário
total_preco_unitario_entrada = 0
total_quantidade_entrada = 0
custo_medio_total_calculado_entrada = 0
custo_medio_unitario_calculado_entrada = 0

total_preco_unitario_saida = 0
total_quantidade_saida = 0
total_custo_calc_saida = 0
custo_medio_total_calculado_saida = 0
custo_medio_unitario_calculado_saida = 0

try:
    if(lista_documentos_ignorar):
        print('Lista Boa')

    if lista_documentos_ignorar is None:
        lista_documentos_ignorar = []

except:
        lista_documentos_ignorar = []

try:
    if(lista_documentos_ignorar_saida):
        print('Lista Boa')
    if lista_documentos_ignorar_saida is None:
        lista_documentos_ignorar_saida = []
except:
    lista_documentos_ignorar_saida = []


origens_unicas = list(set(item["origem"] for item in consulta_movimentos))
origens_unicas_list = []
for origem in origens_unicas:
    origens_unicas_list.append(
        {
            "value" : origem ,
            "label" : origem
        }
    )

del(origens_unicas)
del(origem)

total_preco_unitario = 0
total_quantidade = 0

entrada = []
saida = []

custo_medio = 0
if isinstance(consulta_movimentos_out, list):
    for produtoAux in consulta_movimentos_out:
        if produtoAux['tipo'] == "E" :
            if produtoAux['canceled'] == 'N' or produtoAux['canceled'] == 'Y' or produtoAux['canceled'] == 'C':
                total_preco_unitario_entrada += produtoAux['linetotal']
                total_quantidade_entrada += produtoAux['qtde']
                
                total_preco_unitario += produtoAux['linetotal']
                total_quantidade += produtoAux['qtde']
                
                print("LOG-MAILON | total_preco_unitario: " + str (total_preco_unitario) + ' total_quantidade: ' + str(total_quantidade) + ' custo_medio: ' + str(custo_medio) + ' docnum: ' + str( produtoAux['docnum']))
                if ( total_quantidade) &gt; 0:
                    custo_medio = total_preco_unitario / total_quantidade
                elif (total_quantidade ) == 0:
                    custo_medio = 0
                else: 
                    custo_medio = (custo_medio + (produtoAux['linetotal'] / produtoAux['qtde'])) / 2
                
                produtoAux['custo_medio'] = custo_medio
                produtoAux['estoque_atual'] = total_quantidade
                produtoAux['custo_estoque_atual'] = custo_medio * total_quantidade
                produtoAux['custo_medio_calc'] = produtoAux['linetotal']
                produtoAux['custo_total_contabil'] = produtoAux['linetotal']

                #Calcular Custo Médio da Entrada Ignorando documentos Selecionados
                if(lista_documentos_ignorar != []):
                    ignorar = False

                    for doc_ignorar in lista_documentos_ignorar:
                        tipo_ignorar = doc_ignorar["tipo_documento"]
                        num_ignorar = doc_ignorar["num_documento"]
                        if produtoAux["origem"] == tipo_ignorar and produtoAux["docnum"] == num_ignorar:
                            ignorar = True
                            break

                    if(ignorar == False):
                        custo_medio_total_calculado_entrada += produtoAux['custo_medio_calc']

                        if(custo_medio_unitario_calculado_entrada &gt; 0 ):
                            custo_medio_unitario_calculado_entrada = (custo_medio_unitario_calculado_entrada + produtoAux['custo_medio'])/2
                        else:
                            custo_medio_unitario_calculado_entrada = produtoAux['custo_medio']
                    else:
                        produtoAux['qtde'] = doc_ignorar['qtde']
                        produtoAux['custo_medio_calc'] = doc_ignorar['qtde'] * doc_ignorar['custo_unitario']
                        produtoAux['custo_medio'] = doc_ignorar['custo_unitario']
                        
                        custo_medio_total_calculado_entrada += produtoAux['custo_medio_calc']

                        if(custo_medio_unitario_calculado_entrada &gt; 0 ):
                            custo_medio_unitario_calculado_entrada = (custo_medio_unitario_calculado_entrada + produtoAux['custo_medio'])/2
                        else:
                            custo_medio_unitario_calculado_entrada = produtoAux['custo_medio']


                    del(doc_ignorar)
                    del(ignorar)                      
                else:
                    custo_medio_total_calculado_entrada += produtoAux['custo_medio_calc']
                    
                    if(custo_medio_unitario_calculado_entrada &gt; 0 ):
                        custo_medio_unitario_calculado_entrada = (custo_medio_unitario_calculado_entrada + produtoAux['custo_medio'])/2
                    else:
                        custo_medio_unitario_calculado_entrada = produtoAux['custo_medio']
            else:
                produtoAux['custo_medio'] = 000.000
                produtoAux['estoque_atual'] = 000.000
                produtoAux['custo_medio_calc'] = 000.000
                produtoAux['custo_total_contabil'] = 000.000
                produtoAux['custo_estoque_atual'] = 000.000
        
        if produtoAux['tipo'] == "S":
            if produtoAux['canceled'] == 'N' or produtoAux['canceled'] == 'Y' or produtoAux['canceled'] == 'C':

                if(produtoAux['origem'] == '4-Nfe.Saida' and  produtoAux['canceled'] == 'C'):
                    produtoAux['stockprice'] = produtoAux['stockprice'] * -1
                    produtoAux['qtde'] = produtoAux['qtde'] * -1
                    produtoAux['linetotal'] = produtoAux['linetotal'] * -1

                total_preco_unitario_saida += produtoAux['stockprice'] * produtoAux['qtde']
                total_quantidade_saida += produtoAux['qtde']
                produtoAux['custo_medio'] = custo_medio
                produtoAux['custo_medio_calc'] = custo_medio * produtoAux['qtde']
                total_quantidade = produtoAux['qtde'] +  total_quantidade
                produtoAux['estoque_atual'] = total_quantidade
                produtoAux['custo_estoque_atual'] = custo_medio * total_quantidade
                total_custo_calc_saida += produtoAux['custo_medio_calc']
                total_preco_unitario = produtoAux['custo_medio_calc'] + total_preco_unitario 
                produtoAux['custo_total_contabil'] = produtoAux['stockprice'] * produtoAux['qtde']
                produtoAux['preco_unitario'] = produtoAux['stockprice']


                #Calcular Custo Médio da Entrada Ignorando documentos Selecionados
                if(lista_documentos_ignorar_saida != []):
                    ignorar = False

                    for doc_ignorar in lista_documentos_ignorar_saida:
                        tipo_ignorar = doc_ignorar["tipo_documento"]
                        num_ignorar = doc_ignorar["num_documento"]
                        if produtoAux["origem"] == tipo_ignorar and produtoAux["docnum"] == num_ignorar:
                            ignorar = True
                            break
                            
                    del(doc_ignorar)

                    if(ignorar == False):
                        custo_medio_total_calculado_saida += produtoAux['custo_medio_calc']

                        if(custo_medio_unitario_calculado_saida &gt; 0 ):
                            custo_medio_unitario_calculado_saida = (custo_medio_unitario_calculado_saida + produtoAux['custo_medio'])/2
                        else:
                            custo_medio_unitario_calculado_saida = produtoAux['custo_medio']    

                    del(ignorar)
                else:
                    custo_medio_total_calculado_saida += produtoAux['custo_medio_calc']
                    
                    if(custo_medio_unitario_calculado_saida &gt; 0 ):
                        custo_medio_unitario_calculado_saida = (custo_medio_unitario_calculado_saida + produtoAux['custo_medio'])/2
                    else:
                        custo_medio_unitario_calculado_saida = produtoAux['custo_medio']
            
            else:
                produtoAux['custo_medio'] = 000.000
                produtoAux['estoque_atual'] = 000.000
                produtoAux['custo_medio_calc'] = 000.000
                produtoAux['custo_total_contabil'] = 000.000
                produtoAux['custo_estoque_atual'] = 000.000

    del(produtoAux)

else:
    print("Erro: 'produtosDespositos' não é uma lista.")


total_estoque = total_quantidade_saida + total_quantidade_entrada

custo_medio_unitario_entrada = 0
if total_quantidade_entrada != 0:
    custo_medio_unitario_entrada = total_preco_unitario_entrada / total_quantidade_entrada
    print("Custo médio unitário:", custo_medio_unitario_entrada)
else:
    print("Não foi possível calcular o custo médio unitário. Total de quantidade é zero.")

custo_medio_unitario_saida = 0
if total_quantidade_saida != 0:
    custo_medio_unitario_saida = total_preco_unitario_saida / total_quantidade_saida
    print("Custo médio unitário:", custo_medio_unitario_saida)
else:
    print("Não foi possível calcular o custo médio unitário. Total de quantidade é zero.")



recalcular = False

del(consulta_movimentos)</spiffworkflow:preScript>
        <spiffworkflow:postScript># lista_documentos_ignorar = documentos_entrada
# lista_documentos_ignorar_saida = documentos_saida

del(documento)
del(consulta_movimentos_out)
# del(origens_unicas_list)
# del(documentos_entrada)
# del(documentos_saida)

recalcular == False</spiffworkflow:postScript>
        <spiffworkflow:properties>
          <spiffworkflow:property name="formJsonSchemaFilename" value="" />
          <spiffworkflow:property name="formUiSchemaFilename" value="calculo-custo-estoque-uischema.json" />
        </spiffworkflow:properties>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_1wz3wum</bpmn:incoming>
      <bpmn:outgoing>Flow_04afnxr</bpmn:outgoing>
    </bpmn:manualTask>
    <bpmn:endEvent id="Event_0zik9bp">
      <bpmn:incoming>Flow_0lqskvt</bpmn:incoming>
      <bpmn:incoming>Flow_0nzp5is</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:boundaryEvent id="EncerradoInatividade1" name="Encerrado Inatividade" attachedToRef="SELECIONAR_PRODUTO">
      <bpmn:outgoing>Flow_0lqskvt</bpmn:outgoing>
      <bpmn:timerEventDefinition id="TimerEventDefinition_1c1v85e">
        <bpmn:timeDuration xsi:type="bpmn:tFormalExpression">"PT30M"</bpmn:timeDuration>
      </bpmn:timerEventDefinition>
    </bpmn:boundaryEvent>
    <bpmn:sequenceFlow id="Flow_0lqskvt" sourceRef="EncerradoInatividade1" targetRef="Event_0zik9bp" />
    <bpmn:sequenceFlow id="Flow_0nzp5is" sourceRef="Event_0j1i9fu" targetRef="Event_0zik9bp" />
    <bpmn:boundaryEvent id="Event_0j1i9fu" name="Encerrado Inatividade" attachedToRef="Activity_00bh8bd">
      <bpmn:outgoing>Flow_0nzp5is</bpmn:outgoing>
      <bpmn:timerEventDefinition id="TimerEventDefinition_1rn3tm8">
        <bpmn:timeDuration xsi:type="bpmn:tFormalExpression">"PT30M"</bpmn:timeDuration>
      </bpmn:timerEventDefinition>
    </bpmn:boundaryEvent>
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_ajuste_custo_sap_5dnpvbm">
      <bpmndi:BPMNShape id="_BPMNShape_StartEvent_2" bpmnElement="StartEvent_1">
        <dc:Bounds x="-368" y="159" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_14za570_di" bpmnElement="EndEvent_1">
        <dc:Bounds x="1342" y="159" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0m8n14o_di" bpmnElement="BuscaProdutosPorDepositoSAP">
        <dc:Bounds x="-10" y="137" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1d1r8sl_di" bpmnElement="Activity_1d1r8sl" isExpanded="true">
        <dc:Bounds x="220" y="77" width="550" height="200" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_117o128_di" bpmnElement="Event_117o128">
        <dc:Bounds x="242" y="159" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0s2c0do_di" bpmnElement="ConversorUnidadeMedida">
        <dc:Bounds x="330" y="137" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_01u9h9m_di" bpmnElement="NormalizandoEstoque">
        <dc:Bounds x="510" y="137" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_1dydh6d_di" bpmnElement="Event_1dydh6d">
        <dc:Bounds x="712" y="159" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_1l99k7c_di" bpmnElement="Flow_1l99k7c">
        <di:waypoint x="278" y="177" />
        <di:waypoint x="330" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0f953hs_di" bpmnElement="Flow_0f953hs">
        <di:waypoint x="430" y="177" />
        <di:waypoint x="510" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_14z5yhx_di" bpmnElement="Flow_14z5yhx">
        <di:waypoint x="610" y="177" />
        <di:waypoint x="712" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="Activity_122wunj_di" bpmnElement="Activity_00bh8bd">
        <dc:Bounds x="-150" y="137" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_0mqija0_di" bpmnElement="Gateway_0mqija0" isMarkerVisible="true">
        <dc:Bounds x="125" y="152" width="50" height="50" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_1gw7jjv" bpmnElement="Gateway_0zhxafw" isMarkerVisible="true">
        <dc:Bounds x="15" y="365" width="50" height="50" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0tm9ngj_di" bpmnElement="MovimentoEntradaNaoEncontrado">
        <dc:Bounds x="-10" y="250" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_0p3bhmm_di" bpmnElement="REPROCESSAR01" isMarkerVisible="true">
        <dc:Bounds x="1135" y="152" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1168" y="143" width="64" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0eguz8h_di" bpmnElement="VISAO_SAP">
        <dc:Bounds x="830" y="270" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_1hiqpmg_di" bpmnElement="ESCOLHA_VISAO" isMarkerVisible="true">
        <dc:Bounds x="855" y="152" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="845" y="122" width="70" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_192nt41_di" bpmnElement="SELECIONAR_PRODUTO">
        <dc:Bounds x="-290" y="137" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1m04ayc_di" bpmnElement="VISAO_CALCULADA">
        <dc:Bounds x="980" y="137" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_0zik9bp_di" bpmnElement="Event_0zik9bp">
        <dc:Bounds x="-98" y="-48" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_1dt7gez_di" bpmnElement="Event_0j1i9fu">
        <dc:Bounds x="-98" y="119" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="-67" y="96" width="54" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_0vgnurq_di" bpmnElement="EncerradoInatividade1">
        <dc:Bounds x="-238" y="119" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="-217" y="96" width="54" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_17db3yp_di" bpmnElement="Flow_17db3yp">
        <di:waypoint x="-332" y="177" />
        <di:waypoint x="-290" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_12354sq_di" bpmnElement="Flow_12354sq">
        <di:waypoint x="90" y="177" />
        <di:waypoint x="125" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0kxg7eo_di" bpmnElement="Flow_0kxg7eo">
        <di:waypoint x="770" y="177" />
        <di:waypoint x="855" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_13pu6hq_di" bpmnElement="Flow_13pu6hq">
        <di:waypoint x="-50" y="177" />
        <di:waypoint x="-10" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1yez69d_di" bpmnElement="Flow_1yez69d">
        <di:waypoint x="175" y="177" />
        <di:waypoint x="220" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1462x9u_di" bpmnElement="Flow_1462x9u">
        <di:waypoint x="150" y="202" />
        <di:waypoint x="150" y="290" />
        <di:waypoint x="90" y="290" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0n3n3cb_di" bpmnElement="Flow_0n3n3cb">
        <di:waypoint x="40" y="330" />
        <di:waypoint x="40" y="365" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0ho3zz6_di" bpmnElement="Flow_0ho3zz6">
        <di:waypoint x="15" y="390" />
        <di:waypoint x="-100" y="390" />
        <di:waypoint x="-100" y="217" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_10e4xqh_di" bpmnElement="Flow_10e4xqh">
        <di:waypoint x="1160" y="152" />
        <di:waypoint x="1160" y="0" />
        <di:waypoint x="40" y="0" />
        <di:waypoint x="40" y="137" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0m9nzqu_di" bpmnElement="Flow_0m9nzqu">
        <di:waypoint x="930" y="300" />
        <di:waypoint x="1160" y="300" />
        <di:waypoint x="1160" y="202" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0gxeqjd_di" bpmnElement="Flow_0gxeqjd">
        <di:waypoint x="880" y="202" />
        <di:waypoint x="880" y="270" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1wz3wum_di" bpmnElement="Flow_1wz3wum">
        <di:waypoint x="905" y="177" />
        <di:waypoint x="980" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_04afnxr_di" bpmnElement="Flow_04afnxr">
        <di:waypoint x="1080" y="177" />
        <di:waypoint x="1135" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_053mnsg_di" bpmnElement="Flow_053mnsg">
        <di:waypoint x="1185" y="177" />
        <di:waypoint x="1342" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_129ouwj_di" bpmnElement="Flow_129ouwj">
        <di:waypoint x="65" y="390" />
        <di:waypoint x="1360" y="390" />
        <di:waypoint x="1360" y="195" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0syy6uu_di" bpmnElement="Flow_0syy6uu">
        <di:waypoint x="-190" y="177" />
        <di:waypoint x="-150" y="177" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0lqskvt_di" bpmnElement="Flow_0lqskvt">
        <di:waypoint x="-220" y="119" />
        <di:waypoint x="-220" y="-30" />
        <di:waypoint x="-98" y="-30" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0nzp5is_di" bpmnElement="Flow_0nzp5is">
        <di:waypoint x="-80" y="119" />
        <di:waypoint x="-80" y="-12" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
